<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Flores&Abrazos</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .date-filter{text-align:center;margin:20px}
    .date-filter label{margin-right:10px;font-weight:bold}
  </style>
</head>
<body>
  <div class="header">
    <h1> Flores&Abrazos - Panel de Administraci贸n</h1>
    <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesi贸n</button>
  </div>

  <div class="date-filter">
    <label for="fechaSelector">Ver pedidos del d铆a:</label>
    <input type="date" id="fechaSelector" onchange="cambiarFecha()">
  </div>

  <div class="stats">
    <div class="stat-card"><h3>Pedidos Totales</h3><div class="number" id="totalPedidos">0</div></div>
    <div class="stat-card"><h3>Pedidos Pendientes</h3><div class="number" id="pedidosPendientes">0</div></div>
    <div class="stat-card"><h3>En Preparaci贸n</h3><div class="number" id="pedidosPreparacion">0</div></div>
    <div class="stat-card"><h3>Total del D铆a</h3><div class="number" id="totalVentas">S/ 0</div></div>
  </div>

  <div class="filters">
    <button class="filter-btn active" onclick="filtrarPedidos('todos')">Todos</button>
    <button class="filter-btn" onclick="filtrarPedidos('Pendiente')">Pendientes</button>
    <button class="filter-btn" onclick="filtrarPedidos('Esperando pago')">Esperando Pago</button>
    <button class="filter-btn" onclick="filtrarPedidos('Pedido aceptado')">Aceptados</button>
    <button class="filter-btn" onclick="filtrarPedidos('Preparando pedido')">En Preparaci贸n</button>
    <button class="filter-btn" onclick="filtrarPedidos('Pedido listo')">Listos</button>
    <button class="filter-btn" onclick="filtrarPedidos('Pedido enviado')">Enviados</button>
  </div>

  <div class="pedidos-container" id="pedidosContainer">
    <div class="loading">Cargando pedidos...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, updateDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDWpypggysTY9OyZeuRRHHIF97hmMpa_64",
      authDomain: "flores-peluches.firebaseapp.com",
      projectId: "flores-peluches",
      storageBucket: "flores-peluches.firebasestorage.app",
      messagingSenderId: "1015060675242",
      appId: "1:1015060675242:web:33ddbb687f74db656feed3",
      measurementId: "G-2EQCTGS6QF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let todosPedidos = [];
    let filtroActual = 'todos';
    let fechaSeleccionada = new Date().toISOString().split('T')[0];

    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'index.html';
      else cargarPedidos();
    });

    document.getElementById('fechaSelector').value = fechaSeleccionada;

    function cambiarFecha() {
      fechaSeleccionada = document.getElementById('fechaSelector').value;
      actualizarEstadisticas();
      mostrarPedidos();
    }

    function cargarPedidos() {
      const q = query(collection(db, 'pedidos'), orderBy('fecha', 'desc'));
      onSnapshot(q, snap => {
        todosPedidos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        actualizarEstadisticas();
        mostrarPedidos();
      });
    }

    function actualizarEstadisticas() {
      const [y, m, d] = fechaSeleccionada.split('-').map(Number);
      const inicio = new Date(y, m - 1, d, 0, 0, 0);
      const fin = new Date(y, m - 1, d, 23, 59, 59);
      const delDia = todosPedidos.filter(p => {
        const f = (p.fecha?.toDate ? p.fecha.toDate() : new Date(p.fecha));
        return f >= inicio && f <= fin;
      });
      const pendientes = delDia.filter(p => p.estado === 'Pendiente' || p.estado === 'Esperando pago').length;
      const preparacion = delDia.filter(p => p.estado === 'Preparando pedido').length;
      const total = delDia.reduce((s, p) => s + (p.total_final || 0), 0);
      document.getElementById('totalPedidos').textContent = delDia.length;
      document.getElementById('pedidosPendientes').textContent = pendientes;
      document.getElementById('pedidosPreparacion').textContent = preparacion;
      document.getElementById('totalVentas').textContent = `S/ ${total.toFixed(2)}`;
    }

    function mostrarPedidos() {
      const [y, m, d] = fechaSeleccionada.split('-').map(Number);
      const inicio = new Date(y, m - 1, d, 0, 0, 0);
      const fin = new Date(y, m - 1, d, 23, 59, 59);
      let lista = todosPedidos.filter(p => {
        const f = (p.fecha?.toDate ? p.fecha.toDate() : new Date(p.fecha));
        return f >= inicio && f <= fin;
      });
      if (filtroActual !== 'todos') lista = lista.filter(p => p.estado === filtroActual);
      const container = document.getElementById('pedidosContainer');
      if (!lista.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><h3>Sin pedidos este d铆a</h3></div>';
        return;
      }
      container.innerHTML = lista.map(p => tarjetaPedido(p)).join('');
    }

    function tarjetaPedido(p) {
      const f = (p.fecha?.toDate ? p.fecha.toDate() : new Date(p.fecha));
      const fechaStr = `${f.getDate()}/${f.getMonth() + 1}/${f.getFullYear()} ${f.getHours()}:${f.getMinutes().toString().padStart(2, '0')}`;
      const productos = (p.productos || []).map(pr => `
        <div class="producto-item"><span>${pr.cantidad}x ${pr.nombre}</span><span>S/ ${(pr.subtotal || 0).toFixed(2)}</span></div>`).join('');
      const delivery = p.costo_delivery ? `
        <div class="producto-item"><span>Costo delivery</span><span>S/ ${p.costo_delivery.toFixed(2)}</span></div>` : '';
      const total = (p.total_final || 0).toFixed(2);
      const estados = ['Pendiente', 'Esperando pago', 'Pedido aceptado', 'Preparando pedido', 'Pedido listo', 'Pedido enviado', 'Entregado', 'Cancelado'];
      const opts = estados.map(e => `<option value="${e}" ${p.estado === e ? 'selected' : ''}>${e}</option>`).join('');
      return `
        <div class="pedido-card">
          <div class="pedido-header">
            <div><div class="pedido-id">Pedido #${p.id.substring(0, 8)}</div><small>${fechaStr}</small></div>
            <span class="estado-badge estado-${(p.estado || 'pendiente').toLowerCase().replace(/\s/g, '-')}">${p.estado || 'Pendiente'}</span>
          </div>
          <div class="pedido-info">
            <div class="info-item"><div class="info-label">Cliente</div><div class="info-value">${p.nombre_cliente || 'Sin nombre'}</div></div>
            <div class="info-item"><div class="info-label">Tel茅fono</div><div class="info-value">${p.telefono || 'No disponible'}</div></div>
            ${p.direccion_entrega ? `<div class="info-item"><div class="info-label"> Direcci贸n</div><div class="info-value">${p.direccion_entrega}</div></div>` : ''}
            ${p.notas ? `<div class="info-item"><div class="info-label"> Notas</div><div class="info-value">${p.notas}</div></div>` : ''}
          </div>
          <div class="pedido-productos">
            <strong>Productos:</strong>
            ${productos}
            ${delivery}
            <div class="total-pedido">Total: S/ ${total}</div>
          </div>
          <div class="pedido-actions">
            <select class="estado-select" id="estado-${p.id}">${opts}</select>
            <button class="btn-actualizar" onclick="actualizarEstado('${p.id}')">Actualizar Estado</button>
          </div>
        </div>`;
    }

    window.actualizarEstado = id => {
      const nuevo = document.getElementById(`estado-${id}`).value;
      updateDoc(doc(db, 'pedidos', id), { estado: nuevo })
        .then(() => mostrarNotificacion('Estado actualizado', 'success'))
        .catch(() => mostrarNotificacion('Error al actualizar', 'error'));
    };

    window.filtrarPedidos = f => {
      filtroActual = f;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      mostrarPedidos();
    };

    window.cerrarSesion = () => {
      if (confirm('驴Cerrar sesi贸n?')) signOut(auth).then(() => window.location.href = 'index.html');
    };

    function mostrarNotificacion(msg, tipo) {
        const n = document.createElement('div');
        n.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 14px 18px;
            border-radius: 8px;
            color: #fff;
            background: ${tipo == 'success' ? '#008009' : '#dc3545'};
            z-index: 1000;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,.25);
        `;
        n.textContent = msg;
        document.body.appendChild(n);
        setTimeout(() => n.remove(), 3000);
    }
  </script>
</body>
</html>